name: Auto Deploy Databricks Pipeline

on:
  push:
    paths:
      - 'ahd-data-pipelines/conf.j2/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Poetry
        run: |
          pip install poetry
      
      - name: Install Databricks CLI
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          (echo; echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"') >> /home/runner/.bashrc
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew tap databricks/tap
          brew install databricks
          echo fpath+=$(brew --prefix)/share/zsh/site-functions >> ~/.zshrc
          echo 'autoload -Uz compinit && compinit' >> ~/.zshrc
          export PATH="$PATH:/home/linuxbrew/.linuxbrew/Cellar/databricks/0.218.1/bin"
          echo $PATH

      - name: Output databricks version
        run: /home/linuxbrew/.linuxbrew/Cellar/databricks/0.218.1/bin/databricks -v

      - name: Create Databricks Config File
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_URL_DEV }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN_DEV }}
        run: |
          echo "[ci]" > /home/runner/.databrickscfg
          echo "host = $DATABRICKS_HOST" >> /home/runner/.databrickscfg
          echo "token = $DATABRICKS_TOKEN" >> /home/runner/.databrickscfg

      - name: Get list of changed files (handle no changes)
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD -- 'ahd-data-pipelines/conf.j2/')
          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No changed files found."
          else
            echo "Changed files:"
            echo "$CHANGED_FILES" | grep 'ahd-data-pipelines/conf\.j2/'
          fi

      - name: Determine changes and deploy pipelines
        run: |
          if echo "$CHANGED_FILES" | grep -q 'ahd-data-pipelines/conf\.j2/parameters/census/language/'; then
            echo "Updating Language Pipeline"
          fi

      - name: Extract census_language section
        run: |
          start_line=$(grep -n 'census_language:' conf.j2/data.ci.yml | cut -d ':' -f 1)
          template_line=$(awk "NR==$start_line+2,/template:/" conf.j2/data.ci.yml | grep -n 'template:' | cut -d ':' -f 1)
          if [ -z "$template_line" ]; then
            end_line=$(wc -l < conf.j2/data.ci.yml)
          else
            end_line=$((start_line + template_line - 2)) # -2 to get the line before 'template:'
          fi
          sed -n "${start_line},${end_line}p" conf.j2/data.ci.yml > census_language_section.yml

      - name: Create new file with census_language section
        run: |
          head -n 3 conf.j2/data.ci.yml > conf.j2/data.ci2.yml
          cat census_language_section.yml >> conf.j2/data.ci2.yml

      - name: Output contents of the new file
        run: cat conf.j2/data.ci2.yml

      - name: List stored variables(debug)
        run: |
          env

      - name: Extract template filename and get workflow name
        id: extract-template
        run: |
          template_file=$(awk -F 'template: ' 'NF>1{print $2}' conf.j2/data.ci2.yml)
          template_file="${template_file/conf/conf.j2}"
          
          workflow_name=$(grep 'name:' "$template_file" | cut -d ':' -f 2-)
          echo "::set-output name=workflow_name::$workflow_name"

      - name: Use extracted workflow name
        run: |
          echo "Workflow Name: ${{ steps.extract-template.outputs.workflow_name }}"

# start workflow with ID
# check task status


