
source_datasources:
  - type: databricks
    query: >
        WITH caloes_data AS (
          SELECT *
          FROM ahd_wildfires.silver.caloes_wildfires_{{ env }}
          LIMIT 1
        ),
        main_query AS (
          SELECT
            points.CalculatedAcres,
            perims.Comments,
            perims.ComplexName,
            perims.ComplexID,
            perims.CreateDate,
            perims.CreateDateAge,
            perims.CurrentDateAge,
            points.DailyAcres,
            perims.DateCurrent,
            points.FireDiscoveryDateTime,
            perims.FeatureCategory,
            points.GACC,
            perims.GISAcres,
            perims.GeometryID,
            perims.GlobalID,
            perims.IMTName,
            points.IRWINID,
            points.IncidentName,
            points.IncidentTypeCategory,
            perims.Label,
            perims.LocalIncidentID,
            perims.MapMethod,
            points.PercentContained,
            perims.PolygonDateTime,
            points.PooCounty,
            perims.UnitID,
            perims.ade_date_submitted,
            points.county,
            perims.geometry,
            points.geometry as geometry_x,
            points.oes_region,
            'IRWIN' as Source
          FROM ahd_wildfires.silver.california_fires_points_{{ env }} points
          LEFT JOIN (
            SELECT 
              COUNT(1) as thecount,
              IncidentName,
              FeatureCategory,
              MapMethod,
              Comments,
              GISAcres,
              Label,
              CreateDate,
              DateCurrent,
              PolygonDateTime,
              ComplexName,
              ComplexID,
              GACC,
              IMTName,
              UnitID,
              LocalIncidentID,
              IRWINID,
              GeometryID,
              GlobalID,
              CurrentDateAge,
              CreateDateAge,
              IncidentTypeCategory,
              geometry,
              ade_date_submitted
            FROM ahd_wildfires.silver.california_fires_perims_{{ env }}
            GROUP BY 
              IncidentName,
              FeatureCategory,
              MapMethod,
              Comments,
              GISAcres,
              Label,
              CreateDate,
              DateCurrent,
              PolygonDateTime,
              ComplexName,
              ComplexID,
              GACC,
              IMTName,
              UnitID,
              LocalIncidentID,
              IRWINID,
              GeometryID,
              GlobalID,
              CurrentDateAge,
              CreateDateAge,
              IncidentTypeCategory,
              geometry,
              ade_date_submitted
          ) AS perims ON points.IRWINID = perims.IRWINID
        )
        SELECT * FROM (
          SELECT 
            IncidentSize as `CalculatedAcres`,
            '' as `perims.Comments`,
            '' as `perims.ComplexName`,
            '' as `perims.ComplexID`,
            '' as `perims.CreateDate`,
            '' as `perims.CreateDateAge`,
            '' as `perims.CurrentDateAge`,
            '' as `points.DailyAcres`,
            '' as `perims.DateCurrent`,
            FireDiscoveryDateTime as `points.FireDiscoveryDateTime`,
            '' as `perims.FeatureCategory`,
            GACC as `points.GACC`,
            '' as `perims.GISAcres`,
            '' as `perims.GeometryID`,
            '' as `perims.GlobalID`,
            '' as `perims.IMTName`,
            IrwinID as `points.IRWINID`,
            IncidentName as `points.IncidentName`,
            IncidentTypeCategory as `points.IncidentTypeCategory`,
            '' as `perims.Label`,
            '' as `perims.LocalIncidentID`,
            '' as `perims.MapMethod`,
            PercentContained as `points.PercentContained`,
            '' as `perims.PolygonDateTime`,
            '' as `points.PooCounty`,
            '' as `perims.UnitID`,
            ade_date_submitted as `perims.ade_date_submitted`,
            County as `points.county`,
            '' as `perims.geometry`,
            '' as `geometry_x`,
            '' as `points.oes_region`,
            'OES' as Source
          FROM ahd_wildfires.silver.caloes_wildfires_{{ env }}
          WHERE EXISTS (SELECT 1 FROM caloes_data)

          UNION ALL

          SELECT *
          FROM main_query
          WHERE NOT EXISTS (SELECT 1 FROM caloes_data)
        ) AS combined_result
destination_datasources:
  - type: databricks
    table: ahd_wildfires.gold.california_fires_perims_{{ env }}
    truncate_on_empty: true
    epoch_to_timestamp:
      - CreateDate
      - DateCurrent
      - FireDiscoveryDateTime
      - PolygonDateTime
    drop_columns:
      - geometry_x
    data_types:
    - column: CalculatedAcres
      type: double
    - column: Comments
      type: string
    - column: ComplexName
      type: string
    - column: ComplexID
      type: string
    - column: CreateDate
      type: timestamp
    - column: CreateDateAge
      type: int
    - column: CurrentDateAge
      type: int
    - column: DailyAcres
      type: double
    - column: DateCurrent
      type: timestamp
    - column: FireDiscoveryDateTime
      type: timestamp
    - column: FeatureCategory
      type: string
    - column: GACC
      type: string
    - column: GISAcres
      type: double
    - column: GeometryID
      type: string
    - column: GlobalID
      type: string
    - column: IMTName
      type: string
    - column: IRWINID
      type: string
    - column: Label
      type: string
    - column: LocalIncidentID
      type: string
    - column: MapMethod
      type: string
    - column: PercentContained
      type: double
    - column: PolygonDateTime
      type: timestamp
    - column: PooCounty
      type: string
    - column: UnitID
      type: string
    - column: IncidentTypeCategory
      type: string
    - column: ade_date_submitted
      type: date
    - column: county
      type: string
    - column: geometry
      type: string
    - column: oes_region
      type: string
    - column: source
      type: string
